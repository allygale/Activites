{"version":3,"sources":["tapalong/tapalong_app/client/src/network.js"],"names":[],"mappings":"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","file":"tapalong/tapalong_app/client/src/network.js","sourcesContent":["// TODO: refactor so when adding we don't have to cast string to date here, but it is done in the model\nvar models = require('./models.js');\n\nvar firstListOfActivitiesLoadedFlag = false;\nvar login = function (fb_token, success, failure) {\n  console.log('Logging in to the app');\n  sendRequest('/../v1/login/', 'post', JSON.stringify({fb_token: fb_token}), function() {\n    if(this.status >= 200 && this.status < 400) {\n      console.log(this.responseText);\n      response = JSON.parse(this.responseText);\n      if (response.success === 'true') {\n        success(response.user_id, response.user_name, response.session_token);\n      } else {\n        failure();\n        throw('unexpected app login failure');\n      }\n    } else {\n      // Request failed\n      throw ('login request failed');\n    }\n  });\n};\nvar processActivitiesFromServer = function (responseText) {\n  // Strip activity label for each item\n  var activities = JSON.parse(responseText).map(function (activity) {\n      return activity.activity;\n  });\n  // Convert every date from a string into a date object\n  activities.forEach(function (activity) {\n    // alert(activity.start_time);\n    activity.start_time = new Date(activity.start_time);\n  });\n  models.activities.setActivities(activities);\n  firstListOfActivitiesLoadedFlag = true;\n};\nvar getActivitiesFromServer = function (success, failure) {\n  sendRequest('/../v1/activities/visible_to_user/', 'get', '', function() {\n    if (this.status >= 200 && this.status < 400) {\n      // TODO: Check this actually succeeded\n      processActivitiesFromServer(this.responseText);\n      success();\n    } else {\n      failure();\n    }\n  });\n};\nvar requestCreateActivity = function (activity, success, failure) {\n  sendRequest('/../v1/activities/visible_to_user/', 'post', JSON.stringify(activity), function() {\n    if(this.status >= 200 && this.status < 400) {\n      var activity = JSON.parse(this.responseText).activity;\n      activity.start_time = new Date(activity.start_time);\n      models.activities.addActivity(activity);\n      success();\n    } else {\n      console.log('Server error: ', this.responseText)\n      failure();\n    }\n  });\n};\nvar requestSetAttending = function (activity, attending, optimistic, success, failure) {\n  if (optimistic) {\n    console.log('Set attending optimistically!');\n    // TODO: do a more efficient copy!\n    var activityCopy = JSON.parse(JSON.stringify(activity));\n    // Parse the start_time since we serialized it in the copy :(\n    activityCopy.start_time = new Date(activityCopy.start_time);\n    activityCopy.is_attending = attending;\n    var userName = models.user.getUserName();\n    if (attending) {\n      activityCopy.attendees.push(userName);\n    } else {\n      activityCopy.attendees = activityCopy.attendees.filter(function(attendeeName) {\n        return attendeeName !== userName;\n      });\n    }\n    activityCopy.dirty = true;\n    models.activities.updateActivity(activityCopy.id, activityCopy);\n  }\n  sendRequest('/../v1/activities/'+activity.activity_id+'/attend/', 'post', JSON.stringify({attending: attending}), function () {\n    if(this.status >= 200 && this.status < 400) {\n      var updatedActivity = JSON.parse(this.responseText).activity;\n      updatedActivity.start_time = new Date(updatedActivity.start_time);\n      updatedActivity.id = activity.id;\n      // Note updatedAcitivy won't have dirty set\n      models.activities.updateActivity(updatedActivity.id, updatedActivity);\n      success();\n    } else {\n      failure();\n    }\n  });\n};\nvar requestUpdateActivity = function(activity, activityChanges, success, failure) {\n  sendRequest('/../v1/activities/'+activity.activity_id+'/', 'post', JSON.stringify(activityChanges), function () {\n    if(this.status >= 200 && this.status < 400) {\n      var updatedActivity = JSON.parse(this.responseText).activity;\n      updatedActivity.start_time = new Date(updatedActivity.start_time);\n      updatedActivity.id = activity.id;\n      models.activities.updateActivity(updatedActivity.id, updatedActivity);\n      success();\n    } else {\n      failure();\n    }\n  });\n};\nvar requestCancelActivity = function (activity, success, failure) {\n  sendRequest('/../v1/activities/'+activity.activity_id+'/cancel/', 'post', '', function () {\n    if(this.status >= 200 && this.status < 400) {\n      models.activities.removeActivity(activity.id);\n      success();\n    } else {\n      failure();\n    }\n  })\n};\nvar requestCreatePushNotificationsSubscription = function (subscription) {\n  sendRequest('/../v1/push_subscriptions/', 'post', JSON.stringify(subscription), function () {});\n};\nvar sendRequest = function (url, method, body, onload) {\n  var req = new XMLHttpRequest();\n  req.onload = onload;\n  req.open(method, url, true);\n  // Only set session_token and user_id if the user is logged in.\n  // TODO: Use state in the model to know whether the user is logged in.\n  var sessionToken = models.user.getSessionToken();\n  var userId = models.user.getUserId();\n  if (sessionToken !== undefined && userId !== undefined) {\n    req.setRequestHeader('Session-Token', sessionToken);\n    req.setRequestHeader('User-Id', userId);\n  } else {\n    console.log('Sending an unauthenticated request since we haven\\'t logged in yet');\n  }\n  req.setRequestHeader('Content-Type', 'application/json');\n  setTimeout(function() {\n    req.send(body);\n  }, 0);\n}\nvar sendToServiceWorker = function (data) {\n  navigator.serviceWorker.controller.postMessage(data);\n}\nvar firstListOfActivitiesLoaded = function () {\n  return firstListOfActivitiesLoadedFlag;\n}\n\nmodule.exports = {\n  getActivitiesFromServer: getActivitiesFromServer,\n  requestCreateActivity: requestCreateActivity,\n  requestSetAttending: requestSetAttending,\n  requestUpdateActivity: requestUpdateActivity,\n  requestCancelActivity: requestCancelActivity,\n  requestCreatePushNotificationsSubscription: requestCreatePushNotificationsSubscription,\n  login: login\n};\n"]}