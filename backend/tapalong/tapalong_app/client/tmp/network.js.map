{"version":3,"sources":["tapalong/tapalong_app/client/src/network.js"],"names":[],"mappings":"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","file":"tapalong/tapalong_app/client/src/network.js","sourcesContent":["// TODO: refactor so when adding we don't have to cast string to date here, but it is done in the model\n// TODO: Refactor out dependency on models\n// var models = require('./models.js');\n\nvar sessionToken;\nvar userId;\n\nvar setSessionToken = function(newSessionToken) {\n  sessionToken = newSessionToken;\n}\n\nvar setUserId = function(newUserId) {\n  userId = newUserId;\n}\n\nvar login = function (fb_token, success, failure) {\n  console.log('Logging in to the app');\n  sendRequest('/../v1/login/', 'post', JSON.stringify({fb_token: fb_token}), function() {\n    if(this.status >= 200 && this.status < 400) {\n      console.log(this.responseText);\n      response = JSON.parse(this.responseText);\n      if (response.success === 'true') {\n        success(response.user_id, response.user_name, response.session_token);\n      } else {\n        failure();\n        throw('unexpected app login failure');\n      }\n    } else {\n      // Request failed\n      throw ('login request failed');\n    }\n  });\n};\nvar getActivitiesFromJSON = function (responseText) {\n  // Strip activity label for each item\n  var activities = JSON.parse(responseText).map(function (activity) {\n    // Parse the datetimes into actual objects\n    activity.start_time = new Date(activity.start_time);\n    return activity.activity;\n  });\n  return activities;\n};\nvar getActivitiesFromServer = function (success, failure) {\n  sendRequest('/../v1/activities/visible_to_user/', 'get', '', function() {\n    if (this.status >= 200 && this.status < 400) {\n      // TODO: Check this actually succeeded\n      var activities = getActivitiesFromJSON(this.responseText);\n      success(activities);\n    } else {\n      failure();\n    }\n  });\n};\nvar requestCreateActivity = function (activity, success, failure) {\n  sendRequest('/../v1/activities/visible_to_user/', 'post', JSON.stringify(activity), function() {\n    if(this.status >= 200 && this.status < 400) {\n      var activity = JSON.parse(this.responseText).activity;\n      activity.start_time = new Date(activity.start_time);\n      // models.activities.addActivity(activity);\n      success();\n    } else {\n      console.log('Server error: ', this.responseText)\n      failure();\n    }\n  });\n};\nvar requestSetAttending = function (activity, attending, optimistic, success, failure) {\n  if (optimistic) {\n    console.log('Set attending optimistically!');\n    // TODO: do a more efficient copy!\n    var activityCopy = JSON.parse(JSON.stringify(activity));\n    // Parse the start_time since we serialized it in the copy :(\n    activityCopy.start_time = new Date(activityCopy.start_time);\n    activityCopy.is_attending = attending;\n    // var userName = models.user.getUserName();\n    // if (attending) {\n    //   activityCopy.attendees.push(userName);\n    // } else {\n    //   activityCopy.attendees = activityCopy.attendees.filter(function(attendeeName) {\n    //     return attendeeName !== userName;\n    //   });\n    // }\n    activityCopy.dirty = true;\n    // models.activities.updateActivity(activityCopy.id, activityCopy);\n  }\n  sendRequest('/../v1/activities/'+activity.activity_id+'/attend/', 'post', JSON.stringify({attending: attending}), function () {\n    if(this.status >= 200 && this.status < 400) {\n      var updatedActivity = JSON.parse(this.responseText).activity;\n      updatedActivity.start_time = new Date(updatedActivity.start_time);\n      updatedActivity.id = activity.id;\n      // Note updatedAcitivy won't have dirty set\n      models.activities.updateActivity(updatedActivity.id, updatedActivity);\n      success();\n    } else {\n      failure();\n    }\n  });\n};\nvar requestUpdateActivity = function(activity, activityChanges, success, failure) {\n  sendRequest('/../v1/activities/'+activity.activity_id+'/', 'post', JSON.stringify(activityChanges), function () {\n    if(this.status >= 200 && this.status < 400) {\n      var updatedActivity = JSON.parse(this.responseText).activity;\n      updatedActivity.start_time = new Date(updatedActivity.start_time);\n      updatedActivity.id = activity.id;\n      models.activities.updateActivity(updatedActivity.id, updatedActivity);\n      success();\n    } else {\n      failure();\n    }\n  });\n};\nvar requestCancelActivity = function (activity, success, failure) {\n  sendRequest('/../v1/activities/'+activity.activity_id+'/cancel/', 'post', '', function () {\n    if(this.status >= 200 && this.status < 400) {\n      models.activities.removeActivity(activity.id);\n      success();\n    } else {\n      failure();\n    }\n  })\n};\nvar requestCreatePushNotificationsSubscription = function (subscription) {\n  sendRequest('/../v1/push_subscriptions/', 'post', JSON.stringify(subscription), function () {});\n};\nvar sendRequest = function (url, method, body, onload) {\n  var req = new XMLHttpRequest();\n  req.onload = onload;\n  req.open(method, url, true);\n  // Only set session_token and user_id if the user is logged in.\n  if (sessionToken !== undefined && userId !== undefined) {\n    req.setRequestHeader('Session-Token', sessionToken);\n    req.setRequestHeader('User-Id', userId);\n  } else {\n    console.log('Sending an unauthenticated request since we haven\\'t logged in yet');\n  }\n  req.setRequestHeader('Content-Type', 'application/json');\n  // Why is there a settimeout here?\n  setTimeout(function() {\n    req.send(body);\n  }, 0);\n}\nvar sendToServiceWorker = function (data) {\n  navigator.serviceWorker.controller.postMessage(data);\n}\n\nmodule.exports = {\n  setSessionToken: setSessionToken,\n  setUserId: setUserId,\n  getActivitiesFromServer: getActivitiesFromServer,\n  requestCreateActivity: requestCreateActivity,\n  requestSetAttending: requestSetAttending,\n  requestUpdateActivity: requestUpdateActivity,\n  requestCancelActivity: requestCancelActivity,\n  requestCreatePushNotificationsSubscription: requestCreatePushNotificationsSubscription,\n  login: login\n};\n"]}