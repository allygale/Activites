{"version":3,"sources":["tapalong/tapalong_app/client/src/models.js"],"names":[],"mappings":";;AAAA,IAAI,IAAI,GAAG,OAAO,CAAC,QAAQ,CAAC,CAAC;AAC7B,IAAI,cAAc,GAAG,OAAO,CAAC,eAAe,CAAC,CAAC;AAC9C,IAAI,OAAO,GAAG,OAAO,CAAC,cAAc,CAAC,CAAC;AACtC,IAAI,QAAQ,GAAG,OAAO,CAAC,eAAe,CAAC,CAAC;;AAExC,IAAI,UAAU,GAAG,SAAb,UAAU,CAAa,OAAO,EAAE,OAAO,EAAE,OAAO,EAAE;AACpD,SAAO,CAAC,KAAK,CAAC,OAAO,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC;CAC1C,CAAC;AACF,IAAI,yBAAyB,GAAG,SAA5B,yBAAyB,CAAa,OAAO,EAAE,OAAO,EAAE;AAC1D,SAAO,iBAAiB,CAAC,OAAO,EAAE,OAAO,CAAC,CAAC;CAC5C,CAAC;;AAEF,IAAI,IAAI,GAAG,CAAC,YAAY;AACtB,MAAI,MAAM,CAAC;AACX,MAAI,QAAQ,CAAC;AACb,MAAI,YAAY,CAAC;AACjB,MAAI,cAAc,GAAG,cAAc,EAAE,CAAC;AACtC,MAAI,SAAS,GAAG,SAAZ,SAAS,CAAa,SAAS,EAAE;AACnC,UAAM,GAAG,SAAS,CAAC;AACnB,QAAI,EAAE,GAAG,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;AAC/B,MAAE,CAAC,GAAG,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;AACzB,kBAAc,CAAC,MAAM,EAAE,CAAC;GACzB,CAAC;AACF,MAAI,SAAS,GAAG,SAAZ,SAAS,GAAe;AAC1B,WAAO,MAAM,CAAC;GACf,CAAC;AACF,MAAI,WAAW,GAAG,SAAd,WAAW,CAAa,WAAW,EAAE;AACvC,YAAQ,GAAG,WAAW,CAAC;AACvB,kBAAc,CAAC,MAAM,EAAE,CAAC;GACzB,CAAA;AACD,MAAI,WAAW,GAAG,SAAd,WAAW,GAAe;AAC5B,WAAO,QAAQ,CAAC;GACjB,CAAC;AACF,MAAI,eAAe,GAAG,SAAlB,eAAe,CAAa,eAAe,EAAE;AAC/C,gBAAY,GAAG,eAAe,CAAC;AAC/B,QAAI,EAAE,GAAG,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;AAC/B,MAAE,CAAC,GAAG,CAAC,cAAc,EAAE,YAAY,CAAC,CAAC;AACrC,kBAAc,CAAC,MAAM,EAAE,CAAC;GACzB,CAAC;AACF,MAAI,eAAe,GAAG,SAAlB,eAAe,GAAe;AAChC,WAAO,YAAY,CAAC;GACrB,CAAC;AACF,SAAO;AACL,aAAS,EAAE,SAAS;AACpB,aAAS,EAAE,SAAS;AACpB,eAAW,EAAE,WAAW;AACxB,eAAW,EAAE,WAAW;AACxB,mBAAe,EAAE,eAAe;AAChC,mBAAe,EAAE,eAAe;AAChC,eAAW,EAAE,cAAc,CAAC,WAAW;GACxC,CAAC;CACH,CAAA,EAAG,CAAC;;;AAGL,IAAI,CAAC,WAAW,CAAC,YAAY;AAC3B,SAAO,CAAC,eAAe,CAAC,IAAI,CAAC,eAAe,EAAE,CAAC,CAAC;AAChD,SAAO,CAAC,SAAS,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC,CAAC;CACrC,CAAC,CAAC;;;AAGH,IAAI,UAAU,GAAG,CAAC,YAAY;AAC5B,MAAI,UAAU,GAAG,EAAE,CAAC;AACpB,MAAI,cAAc,GAAG,cAAc,EAAE,CAAC;AACtC,MAAI,aAAa,GAAG,CAAC,CAAC;AACtB,MAAI,WAAW,GAAG,SAAd,WAAW,CAAa,QAAQ,EAAE;AACpC,QAAI,QAAQ,GAAG,mBAAmB,CAAC,QAAQ,CAAC,CAAC;AAC7C,QAAI,CAAC,QAAQ,CAAC,OAAO,EAAE;AACrB,YAAM,KAAK,CAAC,0CAA0C,GAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;KACzE;AACD,YAAQ,CAAC,EAAE,GAAG,aAAa,EAAE,CAAC;AAC9B,cAAU,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;;AAE1B,sBAAkB,EAAE,CAAC;AACrB,kBAAc,CAAC,MAAM,EAAE,CAAC;GACzB,CAAC;;AAEF,MAAI,cAAc,GAAG,SAAjB,cAAc,CAAa,EAAE,EAAE,WAAW,EAAE;AAC9C,QAAI,QAAQ,GAAG,mBAAmB,CAAC,WAAW,CAAC,CAAC;AAChD,QAAI,CAAC,QAAQ,CAAC,OAAO,EAAE;AACrB,YAAM,KAAK,CAAC,4CAA4C,GAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;KAC3E;AACD,QAAI,WAAW,CAAC,EAAE,KAAK,EAAE,EAAE;AACzB,YAAM,IAAI,KAAK,CAAC,sEAAsE,CAAC,CAAC;KACzF;AACD,SAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,UAAU,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;AAC1C,UAAI,UAAU,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,EAAE,EAAE;;AAE1B,kBAAU,CAAC,CAAC,CAAC,GAAG,WAAW,CAAC;OAC7B,CAAC;KACH;AACD,sBAAkB,EAAE,CAAC;AACrB,kBAAc,CAAC,MAAM,EAAE,CAAC;GACzB,CAAA;AACD,MAAI,cAAc,GAAG,SAAjB,cAAc,CAAa,EAAE,EAAE;AACjC,cAAU,GAAG,UAAU,CAAC,MAAM,CAAC,UAAS,QAAQ,EAAE;AAChD,aAAQ,QAAQ,CAAC,EAAE,KAAK,EAAE,CAAE;KAC7B,CAAC,CAAC;AACH,kBAAc,CAAC,MAAM,EAAE,CAAC;GACzB,CAAC;AACF,MAAI,WAAW,GAAG,SAAd,WAAW,CAAa,EAAE,EAAE;AAC9B,WAAO,UAAU,CAAC,MAAM,CAAC,UAAU,QAAQ,EAAE;AAAE,aAAO,QAAQ,CAAC,EAAE,IAAI,EAAE,CAAC;KAAE,CAAE,CAAC,CAAC,CAAC,CAAC;GACjF,CAAC;AACF,MAAI,aAAa,GAAG,SAAhB,aAAa,GAAe;AAC9B,WAAO,UAAU,CAAC;GACnB,CAAC;AACF,MAAI,kBAAkB,GAAG,SAArB,kBAAkB,GAAe;AACnC,WAAO,UAAU,CAAC,MAAM,CAAC;GAC1B,CAAC;AACF,MAAI,aAAa,GAAG,SAAhB,aAAa,CAAa,aAAa,EAAE;AAC3C,cAAU,GAAG,aAAa,CAAC,MAAM,CAAC,UAAS,QAAQ,EAAE;AACnD,UAAI,QAAQ,GAAG,mBAAmB,CAAC,QAAQ,CAAC,CAAC;AAC7C,UAAI,CAAC,QAAQ,CAAC,OAAO,EAAE;AACrB,eAAO,CAAC,GAAG,CAAC,uBAAuB,GAAC,QAAQ,CAAC,WAAW,GAAC,uBAAuB,GAAC,QAAQ,CAAC,MAAM,CAAC,CAAC;OACnG,MAAM;AACL,gBAAQ,CAAC,EAAE,GAAG,aAAa,EAAE,CAAC;OAC/B;AACD,aAAO,QAAQ,CAAC,OAAO,CAAC;KACzB,CAAC,CAAC;AACH,sBAAkB,EAAE,CAAC;AACrB,kBAAc,CAAC,MAAM,EAAE,CAAC;GACzB,CAAC;AACF,MAAI,iBAAiB,GAAG,SAApB,iBAAiB,CAAa,WAAW,EAAE,OAAO,EAAE,OAAO,EAAE;AAC/D,QAAI,QAAQ,GAAG,mBAAmB,CAAC,WAAW,CAAC,CAAC;AAChD,QAAI,QAAQ,CAAC,OAAO,EAAE;AACpB,aAAO,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;AACzB,aAAO,CAAC,qBAAqB,CAAC,WAAW,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC;KAC9D,MAAM;AACL,aAAO,CAAC,GAAG,CAAC,iCAAiC,GAAC,QAAQ,CAAC,MAAM,EAAE,WAAW,CAAC,CAAC;AAC5E,aAAO,EAAE,CAAC;KACX;GACF,CAAC;AACF,MAAI,iBAAiB,GAAG,SAApB,iBAAiB,CAAa,QAAQ,EAAE,eAAe,EAAE,OAAO,EAAE,OAAO,EAAE;AAC7E,WAAO,CAAC,qBAAqB,CAAC,QAAQ,EAAE,eAAe,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC;GAC5E,CAAC;AACF,MAAI,eAAe,GAAG,SAAlB,eAAe,CAAa,QAAQ,EAAE,SAAS,EAAE,UAAU,EAAE,OAAO,EAAE,OAAO,EAAE;AACjF,WAAO,CAAC,mBAAmB,CAAC,QAAQ,EAAE,SAAS,EAAE,UAAU,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC;GAChF,CAAC;AACF,MAAI,YAAY,GAAG,SAAf,YAAY,CAAa,EAAE,EAAE,SAAS,EAAE;AAC1C,UAAM,oDAAoD,CAAE;AAC5D,QAAI,QAAQ,GAAG,WAAW,CAAC,EAAE,CAAC,CAAC;AAC/B,YAAQ,CAAC,YAAY,GAAG,CAAC,QAAQ,CAAC,YAAY,CAAC;AAC/C,kBAAc,CAAC,MAAM,EAAE,CAAC;GACzB,CAAC;AACF,MAAI,iBAAiB,GAAG,SAApB,iBAAiB,CAAa,QAAQ,EAAE,OAAO,EAAE,OAAO,EAAE;AAC5D,WAAO,CAAC,qBAAqB,CAAC,QAAQ,EAAE,OAAO,EAAE,OAAO,CAAC,CAAC;GAC3D,CAAC;;AAEF,MAAI,kBAAkB,GAAG,SAArB,kBAAkB,GAAe;AACnC,cAAU,CAAC,IAAI,CAAC,UAAS,SAAS,EAAE,SAAS,EAAE;AAC7C,OAAC,GAAG,IAAI,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC,OAAO,EAAE,CAAC;AAC7C,OAAC,GAAG,IAAI,IAAI,CAAC,SAAS,CAAC,UAAU,CAAC,CAAC,OAAO,EAAE,CAAC;AAC7C,UAAI,CAAC,GAAG,CAAC,EAAE;AACT,eAAO,CAAC,CAAC,CAAC;OACX,MAAM,IAAI,CAAC,GAAG,CAAC,EAAE;AAChB,eAAO,CAAC,CAAC;OACV,MAAM;AACL,eAAO,AAAC,SAAS,CAAC,EAAE,GAAG,SAAS,CAAC,EAAE,GAAI,CAAC,CAAC,GAAG,CAAC,CAAC;OAC/C;KACF,CAAC,CAAC;AACH,cAAU,CAAC,OAAO,EAAE,CAAC;GACtB,CAAC;AACF,MAAI,mBAAmB,GAAG,SAAtB,mBAAmB,CAAa,QAAQ,EAAE;;;AAG5C,QAAI,UAAU,GAAG,CAAC,eAAe,EAAE,aAAa,EAAE,YAAY,EAAE,OAAO,EAAE,UAAU,CAAC,CAAC;AACrF,QAAI,aAAa,GAAG,UAAU,CAAC,MAAM,CAAC,UAAS,QAAQ,EAAE,QAAQ,EAAE;AACjE,aAAQ,QAAQ,IAAI,QAAQ,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAE;KACxD,EAAE,IAAI,CAAC,CAAC;AACT,QAAI,CAAC,aAAa,EAAE;AAClB,aAAO,EAAC,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,8BAA8B,EAAC,CAAC;KACjE;AACD,QAAI,QAAQ,CAAC,KAAK,IAAI,EAAE,EAAE;AACxB,aAAO,EAAC,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,eAAe,EAAC,CAAC;KAClD;AACD,QAAI,CAAC,QAAQ,CAAC,UAAU,IAAI,EAAE,QAAQ,CAAC,UAAU,YAAY,IAAI,CAAA,AAAC,EAAE;AAClE,aAAO,EAAC,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,+CAA+C,EAAC,CAAC;KAClF;AACD,QAAI,QAAQ,CAAC,UAAU,IAAI,QAAQ,CAAC,UAAU,YAAY,IAAI,EAAE;;AAE9D,aAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC;AACjC,UAAI,GAAG,GAAG,IAAI,IAAI,EAAA,CAAC;AACnB,SAAG,GAAG,GAAG,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,EAAE,CAAC;AAC1B,UAAI,QAAQ,CAAC,UAAU,GAAG,GAAG,EAAE;AAC7B,eAAO,EAAC,OAAO,EAAE,KAAK,EAAE,MAAM,EAAE,QAAQ,GAAG,QAAQ,CAAC,UAAU,CAAC,QAAQ,EAAE,GAAG,mBAAmB,EAAC,CAAC;OAClG;KACF;AACD,WAAO,EAAC,OAAO,EAAE,IAAI,EAAC,CAAC;GACxB,CAAC;AACF,MAAI,oBAAoB,GAAG,SAAvB,oBAAoB,CAAa,OAAO,EAAE,OAAO,EAAE;AACrD,WAAO,CAAC,uBAAuB,CAAC,UAAU,UAAU,EAAE;AACpD,mBAAa,CAAC,UAAU,CAAC,CAAC;AAC1B,aAAO,EAAE,CAAC;KACX,EAAE,OAAO,CAAC,CAAC;GACb,CAAC;AACF,SAAO;AACL,wBAAoB,EAAE,oBAAoB;AAC1C,qBAAiB,EAAE,iBAAiB;AACpC,qBAAiB,EAAE,iBAAiB;AACpC,mBAAe,EAAE,eAAe;AAChC,qBAAiB,EAAE,iBAAiB;AACpC,gBAAY,EAAE,YAAY;AAC1B,iBAAa,EAAE,aAAa;AAC5B,iBAAa,EAAE,aAAa;AAC5B,sBAAkB,EAAE,kBAAkB;AACtC,eAAW,EAAE,WAAW;AACxB,eAAW,EAAE,WAAW;AACxB,kBAAc,EAAE,cAAc;AAC9B,kBAAc,EAAE,cAAc;AAC9B,eAAW,EAAE,cAAc,CAAC,WAAW;GAExC,CAAA;CACF,CAAA,EAAG,CAAC;;;AAEL,MAAM,CAAC,OAAO,GAAG;AACf,YAAU,EAAE,UAAU;AACtB,MAAI,EAAE,IAAI;AACV,YAAU,EAAE,UAAU;AACtB,2BAAyB,EAAE,yBAAyB;CACrD,CAAA","file":"tapalong/tapalong_app/client/src/models.js","sourcesContent":["var Date = require('datejs');\nvar ListenerModule = require('./listener.js');\nvar network = require('./network.js');\nvar objectDB = require('./objectdb.js');\n\nvar startLogin = function (fbToken, success, failure) {\n  network.login(fbToken, success, failure);\n};\nvar hasNotificationPermission = function (success, failure) {\n  return hasPushPermission(success, failure);\n};\n\nvar user = (function () {\n  var userId;\n  var userName;\n  var sessionToken;\n  var listenerModule = ListenerModule();\n  var setUserId = function (newUserId) {\n    userId = newUserId;\n    var db = objectDB.open('db-1');\n    db.put('userId', userId);\n    listenerModule.change();\n  };\n  var getUserId = function () {\n    return userId;\n  };\n  var setUserName = function (newUserName) {\n    userName = newUserName;\n    listenerModule.change();\n  }\n  var getUserName = function () {\n    return userName;\n  };\n  var setSessionToken = function (newSessionToken) {\n    sessionToken = newSessionToken;\n    var db = objectDB.open('db-1');\n    db.put('sessionToken', sessionToken);\n    listenerModule.change();\n  };\n  var getSessionToken = function () {\n    return sessionToken;\n  };\n  return {\n    setUserId: setUserId,\n    getUserId: getUserId,\n    setUserName: setUserName,\n    getUserName: getUserName,\n    setSessionToken: setSessionToken,\n    getSessionToken: getSessionToken,\n    addListener: listenerModule.addListener\n  };\n})();\n\n// We didn't want to have the network import models so update them when things change\nuser.addListener(function () {\n  network.setSessionToken(user.getSessionToken());\n  network.setUserId(user.getUserId());\n});\n\n// TODO: Check that all the activities are still valid with an interval\nvar activities = (function () {\n  var activities = [];\n  var listenerModule = ListenerModule();\n  var maxActivityId = 0;\n  var addActivity = function (activity) {\n    var validity = validateNewActivity(activity);\n    if (!validity.isValid) {\n      throw Error('Invalid activity attempted to be added: '+validity.reason);\n    }\n    activity.id = maxActivityId++;\n    activities.push(activity);\n    // TODO(owen): insert at the right point to maintain date sort rather than this hack\n    fixActivitiesOrder();\n    listenerModule.change();\n  };\n  // Use this so we don't trigger two change events when we remove and readd\n  var updateActivity = function (id, newActivity) {\n    var validity = validateNewActivity(newActivity);\n    if (!validity.isValid) {\n      throw Error('Invalid activity attempted to be updated: '+validity.reason);\n    }\n    if (newActivity.id !== id) {\n      throw new Error('Tried to update an activity to a new activity whose id didn\\'t match');\n    }\n    for (var i = 0; i < activities.length; i++) {\n      if (activities[i].id == id) {\n        // Instead of modifying the one activity, maybe just splice the array and replace it?\n        activities[i] = newActivity;\n      };\n    }\n    fixActivitiesOrder();\n    listenerModule.change();\n  }\n  var removeActivity = function (id) {\n    activities = activities.filter(function(activity) {\n      return (activity.id !== id);\n    });\n    listenerModule.change();\n  };\n  var getActivity = function (id) {\n    return activities.filter(function (activity) { return activity.id == id; } )[0];\n  };\n  var getActivities = function () {\n    return activities;\n  };\n  var getActivitiesCount = function () {\n    return activities.length;\n  };\n  var setActivities = function (newActivities) {\n    activities = newActivities.filter(function(activity) {\n      var validity = validateNewActivity(activity);\n      if (!validity.isValid) {\n        console.log('Not showing activity '+activity.activity_id+' from server because '+validity.reason);\n      } else {\n        activity.id = maxActivityId++;\n      }\n      return validity.isValid;\n    });\n    fixActivitiesOrder();\n    listenerModule.change();\n  };\n  var tryCreateActivity = function (newActivity, success, failure) {\n    var validity = validateNewActivity(newActivity);\n    if (validity.isValid) {\n      console.log(newActivity);\n      network.requestCreateActivity(newActivity, success, failure);\n    } else {\n      console.log('activity wasn\\'t valid because '+validity.reason, newActivity);\n      failure();\n    }\n  };\n  var tryUpdateActivity = function (activity, activityChanges, success, failure) {\n    network.requestUpdateActivity(activity, activityChanges, success, failure);\n  };\n  var trySetAttending = function (activity, attending, optimistic, success, failure) {\n    network.requestSetAttending(activity, attending, optimistic, success, failure);\n  };\n  var setAttending = function (id, attending) {\n    throw('Should not be changing is_attending on client side');\n    var activity = getActivity(id);\n    activity.is_attending = !activity.is_attending;\n    listenerModule.change();\n  };\n  var tryCancelActivity = function (activity, success, failure) {\n    network.requestCancelActivity(activity, success, failure);\n  };\n  // TODO: Make me much more efficient plz!\n  var fixActivitiesOrder = function () {\n    activities.sort(function(activityA, activityB) {\n      a = new Date(activityA.start_time).getTime();\n      b = new Date(activityB.start_time).getTime();\n      if (a > b) {\n        return -1;\n      } else if (b > a) {\n        return 1;\n      } else {\n        return (activityA.id < activityB.id) ? -1 : 1;\n      }\n    });\n    activities.reverse();\n  };\n  var validateNewActivity = function (activity) {\n    // TODO: Validate values of the properties\n    // TODO: Validate client generated ones separately to server given ones\n    var properties = ['max_attendees', 'description', 'start_time', 'title', 'location'];\n    var hasProperties = properties.reduce(function(previous, property) {\n      return (previous && activity.hasOwnProperty(property));\n    }, true);\n    if (!hasProperties) {\n      return {isValid: false, reason: 'some properties were missing'};\n    }\n    if (activity.title == '') {\n      return {isValid: false, reason: 'missing title'};\n    }\n    if (!activity.start_time || !(activity.start_time instanceof Date)) {\n      return {isValid: false, reason: 'start_time wasnt a date object or was missing'};\n    }\n    if (activity.start_time && activity.start_time instanceof Date) {\n      // Allow users to see and edit events up to 2 hours in the past\n      console.log(activity.start_time);\n      var now = new Date;\n      now = now.add(-2).hours();\n      if (activity.start_time < now) {\n        return {isValid: false, reason: 'date (' + activity.start_time.toString() + ') was in the past'};\n      }\n    }\n    return {isValid: true};\n  };\n  var tryRefreshActivities = function (success, failure) {\n    network.getActivitiesFromServer(function (activities) {\n      setActivities(activities);\n      success();\n    }, failure);\n  };\n  return {\n    tryRefreshActivities: tryRefreshActivities,\n    tryCreateActivity: tryCreateActivity,\n    tryUpdateActivity: tryUpdateActivity,\n    trySetAttending: trySetAttending,\n    tryCancelActivity: tryCancelActivity,\n    setAttending: setAttending,\n    setActivities: setActivities,\n    getActivities: getActivities,\n    getActivitiesCount: getActivitiesCount,\n    getActivity: getActivity,\n    addActivity: addActivity,\n    removeActivity: removeActivity,\n    updateActivity: updateActivity,\n    addListener: listenerModule.addListener,\n    // hasActivitiesFromFriends: hasActivitiesFromFriends\n  }\n})();\n\nmodule.exports = {\n  activities: activities,\n  user: user,\n  startLogin: startLogin,\n  hasNotificationPermission: hasNotificationPermission\n}\n"]}