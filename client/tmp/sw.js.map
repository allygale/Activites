{"version":3,"sources":["client/js/sw/sw.js"],"names":[],"mappings":"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","file":"client/js/sw/sw.js","sourcesContent":["'use strict';\nvar objectDB = require('./objectdb.js');\n\nvar version = 1;\nvar logging = true;\n\nvar log = function () {\n  if (logging) {\n    console.log.apply(console, arguments);\n  }\n}\nvar userId;\nvar sessionToken;\n\nself.addEventListener('install', function(e) {\n    //Automatically take over the previous worker.\n    e.waitUntil(self.skipWaiting());\n});\n\nself.addEventListener('activate', function(e) {\n  log('Activated ServiceWorker version: ' + version);\n});\n\n//Handle the push received event.\nself.addEventListener('push', function(e) {\n  log('push listener', e);\n  e.waitUntil(new Promise(function(resolve, reject) {\n    getNotifications(function (notifications) {\n      // This is async so resolve once it's done and the notifications are showing\n      showNotificationsIfNotShownPreviously(notifications, resolve);\n    }, function (reason) {\n      reject(reason);\n    });\n  }));\n});\n\nfunction getNotifications(resolve, reject) {\n  // Get the session tokens etc from IDB\n  var db = objectDB.open('db-1');\n  db.get().then(function(data) {\n    var sessionToken = data.sessionToken;\n    var userId = data.userId;\n    if (sessionToken == undefined || userId == undefined) {\n      throw new Error('User was not logged in. Cannot request notifications.');\n    }\n    self.registration.pushManager.getSubscription().then(function(subscription) {\n      if (subscription) {\n        var subscriptionId = subscription.subscriptionId;\n        fetch('/../v1/notifications/for/'+subscriptionId, {\n          headers: {\n            'SESSION_TOKEN': sessionToken,\n            'USER_ID': userId\n          }\n        }).then(function(response) {\n          response.text().then(function(txt) {\n            log('fetched notifications', txt);\n            var notifications = JSON.parse(txt);\n            resolve(notifications);\n          }).catch(reject)\n        }).catch(reject);\n      } else {\n        console.log('Was asked to get notifications before a subscription was created!')\n      }\n    });\n  });\n}\n\nself.addEventListener('notificationclick', function(e) {\n  log('notificationclick listener', e);\n  e.waitUntil(handleNotificationClick(e));\n});\n\n//Utility function to handle the click\nfunction handleNotificationClick(e) {\n  log('Notification clicked: ', e.notification);\n  e.notification.close();\n  return clients.matchAll({\n      type: 'window',\n      includeUncontrolled: false\n  }).catch(function(ex) {\n      console.log(ex);\n  }).then(function(clientList) {\n      return clients.openWindow(e.notification.url);\n  });\n}\n\nfunction showNotificationsIfNotShownPreviously(notifications, success) {\n  var db = objectDB.open('db-1');\n  db.get().then(function(data)  {\n    console.log('data', data);\n    if (data.notificationIds == undefined ) {\n      console.log('data.notificationIds was blank')\n      data.notificationIds = [];\n    }\n    for (var i = 0; i < notifications.length; i++) {\n      var note = notifications[i];\n      if (data.notificationIds.indexOf(note.id) < 0) {\n        console.log('havent shown note '+note.id+' before');\n        data.notificationIds.push(note.id);\n        showNotification(note.title, note.body, note.url, note.icon, note.id);\n      } else {\n        console.log('we showed note '+note.id+' previously so skip it');\n      }\n    }\n    db.put('notificationIds', data.notificationIds);\n    success();\n  });\n}\n\n//Utility function to actually show the notification.\nfunction showNotification(title, body, url, icon, tag) {\n  var options = {\n    body: body,\n    tag: tag,\n    // lang: 'test lang',\n    icon: icon,\n    data: {url: url},\n    vibrate: 1000,\n    noscreen: false\n  };\n  if (self.registration && self.registration.showNotification) {\n    // TODO: ensure this works after the page is closed\n    self.registration.showNotification(title, options);\n  }\n}\n"]}