{"version":3,"sources":["../client/js/network.js"],"names":[],"mappings":"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","file":"network.js","sourcesContent":["// TODO: refactor so when adding we don't have to cast string to date here, but it is done in the model\nrequire('datejs');\n\nvar requestLogin = function (user, fb_token, success, failure) {\n  console.log('Logging in to the app');\n  sendRequest('/../v1/login/', 'post', JSON.stringify({fb_token: fb_token}), user, function() {\n    if(this.status >= 200 && this.status < 400) {\n      console.log(this.responseText);\n      var response = JSON.parse(this.responseText);\n      if (response.success === 'true') {\n        success(response.user_id, response.user_name, response.session_token);\n      } else {\n        failure();\n        throw('unexpected app login failure');\n      }\n    } else {\n      // Request failed\n      throw ('login request failed');\n    }\n  });\n};\nvar parseActivitiesFromJSON = function (responseText) {\n  // Strip activity label for each item\n  var activities = JSON.parse(responseText).map(function (activity) {\n    // Note the list looks like [{activity: {...}}, ...]\n    // Parse the datetimes into actual objects.\n    activity.activity.start_time = new Date(activity.activity.start_time);\n    return activity.activity;\n  });\n  return activities;\n};\nvar requestActivitiesFromServer = function (user, success, failure) {\n  sendRequest('/../v1/activities/visible_to_user/', 'get', '', user, function() {\n    if (this.status >= 200 && this.status < 400) {\n      // TODO: Check this actually succeeded\n      var activities = parseActivitiesFromJSON(this.responseText);\n      success(activities);\n    } else {\n      failure();\n    }\n  });\n};\nvar requestCreateActivity = function (user, activity, success, failure) {\n  sendRequest('/../v1/activities/visible_to_user/', 'post', JSON.stringify(activity), user, function() {\n    if(this.status >= 200 && this.status < 400) {\n      var activity = JSON.parse(this.responseText).activity;\n      activity.start_time = new Date(activity.start_time);\n      success(activity);\n    } else {\n      console.log('Server error: ', this.responseText)\n      failure();\n    }\n  });\n};\nvar requestSetAttending = function (user, activity, attending, optimistic, success, failure) {\n  if (optimistic) {\n    console.log('Set attending optimistically!');\n    // TODO: do a more efficient copy!\n    var activityCopy = JSON.parse(JSON.stringify(activity));\n    // Parse the start_time since we serialized it in the copy :(\n    activityCopy.start_time = new Date(activityCopy.start_time);\n    activityCopy.is_attending = attending;\n    var userName = user.getUserName();\n    if (attending) {\n      activityCopy.attendees.push(userName);\n    } else {\n      activityCopy.attendees = activityCopy.attendees.filter(function(attendeeName) {\n        return attendeeName !== userName;\n      });\n    }\n    activityCopy.dirty = true;\n    success(activityCopy);\n  }\n  sendRequest('/../v1/activities/'+activity.activity_id+'/attend/', 'post', JSON.stringify({attending: attending}), user, function () {\n    if(this.status >= 200 && this.status < 400) {\n      var updatedActivity = JSON.parse(this.responseText).activity;\n      updatedActivity.start_time = new Date(updatedActivity.start_time);\n      updatedActivity.id = activity.id;\n      // Note updatedAcitivy won't have dirty set\n      success(updatedActivity);\n    } else {\n      failure();\n    }\n  });\n};\nvar requestUpdateActivity = function(user, activity, activityChanges, success, failure) {\n  sendRequest('/../v1/activities/'+activity.activity_id+'/', 'post', JSON.stringify(activityChanges), user, function () {\n    if(this.status >= 200 && this.status < 400) {\n      var updatedActivity = JSON.parse(this.responseText).activity;\n      updatedActivity.start_time = new Date(updatedActivity.start_time);\n      updatedActivity.id = activity.id;\n      success(updatedActivity);\n    } else {\n      failure();\n    }\n  });\n};\nvar requestCancelActivity = function (user, activity, success, failure) {\n  sendRequest('/../v1/activities/'+activity.activity_id+'/cancel/', 'post', '', user, function () {\n    if(this.status >= 200 && this.status < 400) {\n      success(activity);\n    } else {\n      failure();\n    }\n  })\n};\nvar requestCreatePushNotificationsSubscription = function (user, subscription) {\n  console.log(subscription, JSON.stringify(subscription));\n  sendRequest('/../v1/push_subscriptions/', 'post', JSON.stringify(subscription), user, function () {});\n};\nvar sendRequest = function (url, method, body, user, onload) {\n  var req = new XMLHttpRequest();\n  req.onload = onload;\n  req.open(method, url, true);\n  // The user isn't logged in when they are logging in\n  if (user.isLoggedIn()) {\n    req.setRequestHeader('Session-Token', user.getSessionToken());\n    req.setRequestHeader('User-Id', user.getUserId());\n  } else {\n    console.log('Sending an unauthenticated request since we haven\\'t logged in yet');\n  }\n  req.setRequestHeader('Content-Type', 'application/json');\n  // Why is there a settimeout here?\n  setTimeout(function() {\n    req.send(body);\n  }, 0);\n}\nvar sendToServiceWorker = function (data) {\n  navigator.serviceWorker.controller.postMessage(data);\n}\n\nmodule.exports = {\n  requestActivitiesFromServer: requestActivitiesFromServer,\n  requestCreateActivity: requestCreateActivity,\n  requestSetAttending: requestSetAttending,\n  requestUpdateActivity: requestUpdateActivity,\n  requestCancelActivity: requestCancelActivity,\n  requestCreatePushNotificationsSubscription: requestCreatePushNotificationsSubscription,\n  requestLogin: requestLogin\n};\n"]}